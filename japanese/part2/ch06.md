# 米田埋め込み {#yoneda-embedding}

以前見たとおり、圏$\cat{C}$について対象$a$を固定すると、写像$\cat{C}(a, -)$ は$\cat{C}$から$\Set$への（共変）関手となる。
$$x \to \cat{C}(a, x)$$
（Hom集合$\cat{C}(a, x)$ は*集合*なのでこの関手の終域は$\Set$だ。）
この写像はhom関手と呼ばれる。射に対するこの関手の作用についてもすでに定義したことを思い出してほしい。

さて、この写像において$a$を変化させてみよう。すると、Hom*関手*$\cat{C}(a, -)$ を任意の$a$に対して割り当てる新しい写像が得られる。
$$a \to \cat{C}(a, -)$$
これは圏$\cat{C}$の対象たちから関手たち、すなわち関手圏の*対象*たちへの写像だ（関手圏については[自然変換](#natural-transformations)（第10章3節）
を参照）。$\cat{C}$から$\Set$への関手圏を$[\cat{C}, \Set]$と表記しよう。また、覚えているかもしれないが、Hom関手は[表現可能関手](#representable-functors)（第14章）の原型だった。

2つの圏の間に対象の写像があるのを見るたび、そのような写像が関手でもあるかを問うのは自然なことだ。言い換えると、一方の圏の射をもう一方の圏の射へと持ち上げられるか、ということだ。$\cat{C}$の射は$\cat{C}(a, b)$ の要素にすぎないが、関手圏$[\cat{C}, \Set]$の射は自然変換だ。つまり、ここでは射から自然変換への写像を探していることになる。

射$f \Colon a \to b$に対応する自然変換が見つかるか見てみよう。そのため、まず$a$と$b$が何に写されるか見てみよう。それらは2つの関手$\cat{C}(a, -)$ と$\cat{C}(b, -)$ に写される。求めるものは、これら2つの関手の間の自然変換だ。

そして、ここで秘訣がある。米田の補題：
$$[\cat{C}, \Set](\cat{C}(a, -), F) \cong F a$$
を使い、さらに総称的な$F$をhom関手$\cat{C}(b, -)$ で置き換える。すると、次が得られる：
$$[\cat{C}, \Set](\cat{C}(a, -), \cat{C}(b, -)) \cong \cat{C}(b, a)$$

`\begin{figure}[H] \centering`{=latex}
![](images/yoneda-embedding.jpg){width=60%}
`\end{figure}`{=latex}

\noindent
これはまさに探していた2つのhom関手の間の自然変換だが、少しねじれがある。つまり、自然変換と射との対応は見つけたのだが、射――$\cat{C}(b, a)$ の要素――の向きが「間違って」いる。でも大丈夫だ。それは単に注目している関手が反変であることを意味する。

`\begin{figure}[H] \centering`{=latex}
![](images/yoneda-embedding-2.jpg){width=65%}
`\end{figure}`{=latex}

\noindent
実際には、期待以上のものが得られた。$\cat{C}$から$[\cat{C}, \Set]$への写像は反変関手というだけではない――それは*充満忠実* (fully faithful) 関手なのだ。充満性と忠実性という特性は、関手がhom集合をどう写すかを述べている。

*忠実* (faithful) 関手はhom集合上の*単射*だ。つまり、別々の射は別々の射へと写す。言い換えれば、射を潰さない。

*充満* (full) 関手はhom集合上の*全射*だ。つまり、一方のhom集合をもう一方のhom集合の*上へ*写し、後者を完全にカバーする。

充満忠実関手$F$はhom集合上の[*全単射*]{.keyword #bijection}\index{全単射} (bijection) であり、つまり両方の集合のすべての要素が1対1で対応する。もとの圏$\cat{C}$内の対象$a$と$b$のすべてのペアに対して、$\cat{C}(a, b)$ と$\cat{D}(F a, F b)$ の間に全単射がある。ここで、$\cat{D}$は$F$の行き先の圏（この場合は関手圏$[\cat{C}, \Set]$）だ。ただし、これは$F$が*対象*について全単射であることを意味しないので注意してほしい。$\cat{D}$内の対象のうち$F$の像内にないものが存在する可能性があり、それらの対象についてのhom集合たちに関しては何も言えない。

## 埋め込み

先ほど説明した（反変）関手、すなわち、$\cat{C}$内の対象を$[\cat{C}, \Set]$内の関手に写す関手：
$$a \to \cat{C}(a, -)$$
は[*米田埋め込み*]{.keyword #Yoneda_embedding}\index{米田埋め込み} (Yoneda embedding) を定義する。それは圏$\cat{C}$（厳密に言うと反変なので圏$\cat{C}^\mathit{op}$）を関手圏$[\cat{C}, \Set]$の内部に*埋め込む*。$\cat{C}$内の対象を関手に写すだけでなく、それらの間のすべての接続を忠実に保持する。

これは非常に有用な結果だ。なぜなら、数学者は関手圏について、特に終域が$\Set$である関手について多くのことを知っているからだ。任意の圏$\cat{C}$について、関手圏へ埋め込むことで多くの知見が得られる。

もちろん米田埋め込みにも双対があり、それは余米田埋め込み (co-Yoneda embedding) と呼ばれることもある。議論の始めの時点で（始域となる対象ではなく）終域となる対象を固定したhom集合$\cat{C}(-, a)$ を考えても良かったことに着目しよう。そうすれば反変hom関手が得られていたことになる。$\cat{C}$から$\Set$への反変関手は、おなじみの前層だ (たとえば、第12章の[極限と余極限](#limits-and-colimits)を参照)。余米田埋め込みは圏$\cat{C}$の前層圏への埋め込みを定義する。射に対する作用は次によって与えられる：
$$[\cat{C}^\mathit{op}, \Set](\cat{C}(-, a), \cat{C}(-, b)) \cong \cat{C}(a, b)$$
ここでも、数学者は前層圏について多くのことを知っているので、任意の圏をそれに埋め込めるのは大きな戦果だ。

## Haskellへの応用

Haskellでの米田埋め込みは、式の一辺がreader関手同士の自然変換、他辺が（逆方向へ向かう）関数であるような同型として表せる：

```haskell
forall x. (a -> x) -> (b -> x) ≅ b -> a
```

\noindent
(Reader関手が`((->) a)`と等価であることを思い出してほしい。)

この等式の左辺は、`a`から`x`への関数と型`b`の値が与えられたときに、型`x`の値を生成できるような多相関数だ（ここでは非カリー化した視点で、つまり関数`b -> x`の周りの括弧を除いて考えている）。これをすべての`x`に対して行えるのは、関数が`b`を`a`に変換する方法を知っている場合だけだ。関数`b -> a`に密かにアクセスできる必要がある。

そのようなコンバーター`btoa`があれば、この左辺を、`fromY`と呼ぶとして、以下のように定義できる：

```haskell
fromY :: (a -> x) -> b -> x
fromY f b = f (btoa b)
```

\noindent
逆に、関数`fromY`があれば、恒等射について`fromY`を呼び出すことでそのコンバーターを復元できる：

```haskell
fromY id :: b -> a
```

\noindent
これによって関数`fromY`と`btoa`の間に全単射が確立される。

この同型を別の観点で見ると、`b`から`a`への関数を継続渡し形式で表しているとも見なせる。引数`a -> x`は継続（ハンドラー）であると見なせる^[訳注：この見方をするときは左辺の引数の順を入れ替えて`b -> (a -> x) -> x`とすることが多い。]。結果は`b`から`x`への関数であり、型`b`の値を引数として呼ばれたとき、エンコードされようとしている関数に前合成された継続を実行する。

米田埋め込みでHaskellのデータ構造のうちいくつかの別の表現についても説明できる。特に、非常に便利な[レンズの表現](https://bartoszmilewski.com/2015/07/13/from-lenses-to-yoneda-embedding/)^[<https://bartoszmilewski.com/2015/07/13/from-lenses-to-yoneda-embedding/>]を`Control.Lens`ライブラリで提供する。

## 前順序での例

この節の例はRobert Harperによって提案された。前順序によって定義された圏に米田埋め込みを適用するものだ。前順序は要素間に順序関係がある集合であり、この順序関係は伝統的に$\leqslant$（小なりイコール）で記述される。前順序に「前」が付いているのは、関係が推移律 (transitive law) と反射律 (reflexive law) を満たす必要があるだけで、必ずしも反対称律 (antisymmetric law) を満たす必要はないからだ（すなわち、循環してもよい）[^order]。

[^order]: 訳注：集合の任意の元$a, b, c$について

    - 推移律：$a \leqslant b$かつ$b \leqslant c$ならば$a \leqslant c$
    - 反射律：$a \leqslant a$
    - 反対称律：$a \leqslant b$かつ$b \leqslant a$ならば$a = b$

前順序関係を持つ集合は圏をなす。対象となるのはその集合の各要素だ。対象$a$から$b$への射は、対象が比較できない場合や$a \leqslant  b$が真でない場合には存在せず、$a \leqslant b$の場合には$a$から$b$への向きに存在する。ある対象から別の対象への射が2つ以上存在することはない。したがって、このような圏のhom集合はすべて、空集合または単元集合だ。このような圏は*細い圏*と呼ばれる。

この構成が実際に圏であることは簡単に納得できる。まず、射は合成可能だ。なぜなら、$a \leqslant b$かつ$b \leqslant c$ならば$a \leqslant c$だからだ。そして、合成は結合性を持つ。恒等射も存在する。なぜなら、すべての要素がそれ自身（以下）となる（もとになっている順序の反射律）からだ。

これで前順序圏に余米田埋め込みを適用できるようになった。特に興味があるのは射に対する作用だ：
$$[\cat{C}, \Set](\cat{C}(-, a), \cat{C}(-, b)) \cong \cat{C}(a, b)$$
右辺のhom集合が空集合でないのは$a \leqslant b$のときだけだ。その場合は単元集合となる。したがって、$a \leqslant b$の場合、左辺には自然変換が1つだけ存在する。それ以外の場合は自然変換はない。

では、前順序のhom関手間の自然変換とは何だろうか？　それは2つの集合$\cat{C}(-, a)$ と$\cat{C}(-, b)$ の間の関数の族でなければならない。前順序集合では、2つの集合はそれぞれ空集合か単元集合だ。どんな関数があり得るか見てみよう。

空集合からそれ自身への関数（空集合に作用する恒等射)、空集合から単元集合への`absurd`関数（関数の値を定義すべき要素が空集合には1つもないので、何もしない）、そして単元集合からそれ自身への関数 (要素が1つの集合に作用する恒等射）がある。単元集合から空集合への組み合わせだけは禁じられている（そのような関数が単元集合の要素に作用したとして、どんな値を返せばよいだろう？）。

つまり、この自然変換は決してhom単元集合をhom空集合に接続しない。言い換えると、$x \leqslant a$ (hom単元集合$\cat{C}(x, a)$) ならば$\cat{C}(x, b)$ は空集合ではない。空でない$\cat{C}(x, b)$ は$x$が$b$以下であることを意味する。したがって、ここでの自然変換が存在するためには、すべての$x$について、$x \leqslant a$ならば$x \leqslant b$が成り立つ必要がある：
$$\text{任意の } x \text{ について } x \leqslant a \Rightarrow x \leqslant b$$
一方、余米田の補題によると、この自然変換の存在は$\cat{C}(a, b)$ が空でないこと、つまり$a \leqslant b$であることと等価だ。まとめると、次の結果が得られる：
$$a \leqslant b \text{ ならばそのときに限り任意の } x \text{ について } x \leqslant a \Rightarrow x \leqslant b$$
この結果に直接到達することもできただろう。直観的には、$a \leqslant b$ならば$a$以下のすべての要素も$b$以下である必要がある。逆に、$a$を右辺の$x$に代入すると、$a \leqslant b$となる。しかし、米田埋め込みを通じてこの結果に到達する方がはるかに刺激的なのは認めなければならない。

## 自然性

米田の補題は自然変換の集合と$\Set$の対象との間に同型射を設ける。いま扱っている自然変換たちは関手圏$[\cat{C}, \Set]$内の射だ。任意の2つの関手間の自然変換の集合は、関手圏におけるhom集合となる。米田の補題とは次の同型だ：
$$[\cat{C}, \Set](\cat{C}(a, -), F) \cong F a$$
この同型は実は$F$についても$a$についても自然だ。言い換えれば、積圏$[\cat{C}, \Set] \times \cat{C}$から取られたペア $(F, a)$ について自然だ。ここでは$F$を関手圏の*対象*として扱っていることに注意してほしい。

これが何を意味するのか少し考えてみよう。自然同型は2つの関手の間の可逆な*自然変換*だ。そして実際、前述の同型の右辺は関手だ。具体的には$[\cat{C}, \Set]\times \cat{C}$から$\Set$への関手だ。ペア $(F, a)$ に対するその作用は集合――関手$F$を対象$a$において評価した結果――となる。この関手は評価関手 (evaluation functor) と呼ばれる。

左辺も関手であり、$(F, a)$ を自然変換の集合$[\cat{C}, \Set](\cat{C}(a, -), F)$ に変換する。

これらが本当に関手だと示すには、射に対する作用も定義しなければならない。しかし、ペア $(F, a)$ と $(G, b)$ の間の射とは何だろうか？　それは射のペア $(\Phi, f)$ だ。1番目は関手間の射――自然変換――であり、2番目は$\cat{C}$内の通常の射だ。

評価関手はこのペア $(\Phi, f)$ を取り、2つの集合$F a$と$G b$の間の関数に写す。このような関数は、$a$における$\Phi$の成分（$F a$を$G a$に写す）と$G$によってリフトされた射$f$から、簡単に構築できる：
$$(G f) \cdot \Phi_a$$
$\Phi$の自然性により、これは次と同じであることに注意してほしい：
$$\Phi_b \cdot (F f)$$
この同型全体の自然性を証明するつもりはない――関手とは何かが掴めれば、ごく機械的に証明できる。それはこの同型が関手と自然変換から成り立っているという事実から導かれる。うまくいかないはずがない。

## 課題

#. 余米田埋め込みをHaskellで表現せよ。
#. `fromY`と`btoa`の間に確立された全単射が同型である（2つの写像が互いに逆である）ことを示せ。
#. 与えられたモノイドに対し、米田埋め込みを行え。そのモノイドの単一の対象に対応する関手は何か[^q16.5.3]？　どのような自然変換がモノイド射に対応するか？
#. *共変*米田埋め込みを前順序に適用したものは何か？（この問いはGershom Bazermanによって提案された。）
#. 米田埋め込みを使えば、任意の関手圏$[\cat{C}, \cat{D}]$を関手圏$[[\cat{C}, \cat{D}], \Set]$に埋め込める。それが射（この場合は自然変換）にどう作用するか説明せよ。

[^q16.5.3]: 訳注：この問いは15章で出てきたケイリーの定理（のモノイド版）に関連する。また、モノイドが単一対象の圏として表せることについては[圏としてのモノイド](#monoid-as-set)（第3章4節）を参照。]
