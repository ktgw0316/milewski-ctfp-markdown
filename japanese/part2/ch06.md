# 米田埋め込み {#yoneda-embedding}

以前見たとおり、圏$\cat{C}$で対象$a$を固定すると、写像$\cat{C}(a, -)$ は$\cat{C}$から$\Set$への（共変）関手となる。

$$x \to \cat{C}(a, x)$$

(Hom集合$\cat{C}(a, x)$ は*集合*なので終域は$\Set$だ。)
この写像はhom関手と呼ばれる。射に対するその作用についてもすでに定義した。

さて、この写像で$a$を変化させてみよう。Hom*関手*$\cat{C}(a, -)$ を任意の$a$に割り当てる新しい写像が得られる。

$$a \to \cat{C}(a, -)$$

これは圏$\cat{C}$の対象から関手への写像だ。それらの関手は関手圏の*対象*だ ([自然変換](#natural-transformations)の関手圏についての節を参照)。$\cat{C}$から$\Set$への関手圏を$[\cat{C}, Set]$と表記しよう。また、Hom関手が[表現可能関手](#kleisli-categories)の原型だということも思い出しただろう。

2つの圏間の対象の写像を見るたびに、その写像が関手でもあるかどうかを知りたくなるのは自然なことだ。言い換えると、一方の圏の射をもう一方の圏の射へとリフトできるかどうかだ。$\cat{C}$の射は$\cat{C}(a, b)$ の要素にすぎないが、関手圏$[\cat{C}, \Set]$の射は自然変換だ。つまり、射から自然変換への写像を探していることになる。

射$f \Colon a \to b$に対応する自然変換が見つかるかどうか調べよう。まず、$a$と$b$が何に写されているか見てみよう。それらは2つの関手$\cat{C}(a, -)$ と$\cat{C}(b, -)$ に写されている。この2つの関手の間の自然変換が必要だ。

そして、ここが秘訣だ。米田の補題を使う：

$$[\cat{C}, \Set](\cat{C}(a, -), F) \cong F a$$

さらに総称$F$をhom関手$\cat{C}(b, -)$ で置き換える。すると、次の結果が得られる：

$$[\cat{C}, \Set](\cat{C}(a, -), \cat{C}(b, -)) \cong \cat{C}(b, a)$$

![](images/yoneda-embedding.jpg){width=60%}

これはまさに探していた2つのhom関手の間の自然変換だが、少しひねりがある。つまり、自然変換と射――$\cat{C}(b, a)$ の要素――の間の写像の向きが「間違って」いる。でも大丈夫だ。それは単に関手が反変なのを意味する。

![](images/yoneda-embedding-2.jpg){width=65%}

実際、予想以上のものが得られた。$\cat{C}$から$[\cat{C}, \Set]$への写像は反変関手というだけではない――それは*充満忠実* (fully faithful) 関手だ。充実性と忠実性という特性は、関手がhom集合をどう写すかを述べている。

*忠実* (faithful) 関手はhom集合上の*単射*であり、つまり、異なる射を異なる射に写す。言い換えれば、射を合体させない。

*充満* (full) 関手はhom集合上の*全射*であり、つまり、1つのhom集合をもう1つのhom集合の*上に*写し、後者を完全にカバーする。

充満忠実関手$F$はhom集合上の[全単射]{.keyword #bijection} (bijection) であり、両方の集合のすべての要素が1対1で写される。始域圏$\cat{C}$内の対象$a$と$b$のすべてのペアに対して、$\cat{C}(a, b)$ と$\cat{D}(F a, F b)$ の間に全単射がある。ここで、$\cat{D}$は$F$の終域圏（この場合は関手圏$[\cat{C}, \Set]$）だ。ただし、これは$F$が*対象*について全単射であることを意味しないので注意してほしい。$\cat{D}$内の対象のうち$F$の像内にないものが存在する可能性があり、それらの対象のhom集合については何も言えない。

## 埋め込み

先ほど説明した（反変）関手、すなわち、$\cat{C}$内の対象を$[\cat{C}, \Set]$内の関手に写す関手：

$$a \to \cat{C}(a, -)$$

によって[米田埋め込み]{.keyword #Yoneda_embedding} (Yoneda embedding) が定義される。それは圏$\cat{C}$（厳密に言うと反変なので圏$\cat{C}^\mathit{op}$）を関手圏$[\cat{C}, \Set]$の内部に*埋め込む*。$\cat{C}$内の対象を関手に写すだけでなく、それらの間のすべての接続を忠実に保持する。

これは非常に有用な結果だ。なぜなら、数学者は関手圏について、特に終域が$\Set$である関手についてよく知っているからだ。任意の圏$\cat{C}$について、関手圏へ埋め込むことで多くの知見を得られる。

当然だが米田埋め込みにも双対があり、余米田埋め込み (co-Yoneda embedding) とも呼ばれる。始めの時点で各hom集合$\cat{C}(-, a)$ の（始対象ではなく）終対象を固定しても良かったことに着目しよう。そうすれば反変hom関手が得られただろう。$\cat{C}$から$\Set$への反変関手は、おなじみの前層だ (たとえば、[極限と余極限](#limits-and-colimits)を参照)。余米田埋め込みは圏$\cat{C}$の前層圏への埋め込みを定義する。射に対する作用は次のように与えられる：

$$[\cat{C}, \Set](\cat{C}(-, a), \cat{C}(-, b)) \cong \cat{C}(a, b)$$

数学者は前層圏についても多くのことを知っているので、そこに任意の圏を埋め込めるのは大きな戦果だ。

## Haskellへの応用

Haskellでの米田埋め込みは、一方ではreader関手の自然変換の間の同型として、他方では（逆向きの）関数として表せる：

```haskell
forall x. (a -> x) -> (b -> x) ≅ b -> a
```

(Reader関手が`((->) a)`と等価であることを思い出してほしい。)

この恒等射の左辺は多相関数であり、`a`から`x`への関数と型`b`の値が与えられれば、型`x`の値を生成できる（関数`b -> x`を非カリー化することにより、括弧で囲むのを省略する）。これをすべての`x`に対して行える唯一の方法は、関数が`b`を`a`に変換する方法を知っている場合だ。関数`b -> a`に密かにアクセスできる必要がある。

そのようなコンバーター`btoa`があれば、左辺を定義できる。左辺は`fromY`と呼ばれ、次のようになる：

```haskell
fromY :: (a -> x) -> b -> x
fromY f b = f (btoa b)
```

逆に、関数`fromY`があれば、恒等射で`fromY`を呼び出すことでコンバーターを復元できる：

```haskell
fromY id :: b -> a
```

これは型`fromY`と`btoa`の関数間の全単射を確立する。

この同型を別の観点で見ると、`b`から`a`への関数のCPS符号化とも見なせる。引数`a -> x`は継続（ハンドラー）だ。結果は`b`から`x`への関数であり、型`b`の値で呼ばれたとき、エンコードされた関数を前合成した継続を実行する。

米田埋め込みはHaskellのデータ構造の代替表現についても説明する。特に、非常に便利な[レンズの表現](https://bartoszmilewski.com/2015/07/13/from-lenses-to-yoneda-embedding/)を`Control.Lens`ライブラリで提供する。

## 前順序の例

この節の例はRobert Harperによって提案された。前順序によって定義された圏に米田埋め込みを適用するものだ。前順序は要素間に順序関係がある集合だ。順序関係は伝統的に$\leqslant$（以下）で記述される。前順序に「前」が付いているのは、関係が推移律 (transitive law) と反射律 (reflexive law) を満たす必要があるだけで、必ずしも反対称律を満たす必要はないからだ（すなわち、循環してもよい）。

前順序関係をもつ集合は圏を生成する。対象はその集合の要素だ。対象$a$から$b$への射は、対象が比較できない場合や$a \leqslant  b$が真でない場合には存在せず、$a \leqslant b$の場合には$a$から$b$への向きに存在する。ある対象から別の対象への射が2つ以上存在することはない。したがって、このような圏のhom集合はすべて、空集合または単集合だ。このような圏は*薄い圏* (thin category) と呼ばれる。

この構成が実際に圏であることは簡単に納得できる。まず、矢は合成可能だ。なぜなら、$a \leqslant b$かつ$b \leqslant c$ならば$a \leqslant c$だからだ。そして、合成は結合性を持つ。恒等射も存在する。なぜなら、（基礎となる関係から再帰的に）すべての要素がそれ自身（以下）となるからだ。

これで前順序圏に余米田埋め込みを適用できるようになった。特に、射に対する作用には興味がある：

$$[\cat{C}, \Set](\cat{C}(-, a), \cat{C}(-, b)) \cong \cat{C}(a, b)$$

右辺のhom集合が空集合でないのは$a \leqslant b$のときだけだ。その場合は単集合となる。したがって、$a \leqslant b$の場合、左辺には自然変換が1つだけ存在する。それ以外の場合は自然変換はない。

では、前順序のhom関手間の自然変換とは何だろうか？
それは2つの集合$\cat{C}(-, a)$ と$\cat{C}(-, b)$ の間の関数の族でなければならない。前順序集合では、2つの集合はそれぞれ空集合か単集合だ。どんな関数があり得るか見てみよう。

空集合からそれ自身への関数（空集合に作用する恒等射)、空集合から単集合への`absurd`関数（定義すべき要素が空集合には1つもないので、何もしない）、そして単集合からそれ自身への関数 (要素が1つの集合に作用する恒等射）がある。単集合から空集合への組み合わせだけは禁じられている（そのような関数が単集合の要素に作用したとして、どんな値を返せばよいだろう？）。

したがって、この自然変換は決してhom単集合をhom空集合に接続しない。言い換えると、$x \leqslant a$ (hom単集合$\cat{C}(x, a)$) ならば$\cat{C}(x, b)$ は空集合ではない。空でない$\cat{C}(x, b)$ は$x$が$b$以下であることを意味する。したがって、ここでの自然変換が存在するためには、すべての$x$について、$x \leqslant a$ならば$x \leqslant b$が成り立つ必要がある：

$$\text{for all} x, x \leqslant a \Rightarrow x \leqslant b$$

一方、余米田の補題によると、この自然変換の存在は$\cat{C}(a, b)$ が空でないか$a \leqslant b$であることと等価だ。まとめると、次の結果が得られる：

$$a \leqslant b \text{ if and only if for all } x, x \leqslant a \Rightarrow x \leqslant b$$

この結果に直接到達することもできただろう。直観的には、$a \leqslant b$ならば$a$未満のすべての要素も$b$未満である必要がある。逆に、右辺の$a$を$x$に代入すると、$a \leqslant b$となる。しかし、米田埋め込みを通じてこの結果に到達する方がはるかに刺激的なのは認めなければならない。

## 自然性

米田の補題は、自然変換の集合と$\Set$の対象との間に同型射を設ける。自然変換は関手圏$[\cat{C}, \Set]$内の射だ。任意の2つの関手間の自然変換の集合は、その圏におけるhom集合だ。米田の補題とは次の同型だ：

$$[\cat{C}, \Set](\cat{C}(a, -), F) \cong F a$$

この同型は$F$でも$a$でも自然だと分かる。言い換えれば、直積圏$[\cat{C}, \Set] \times \cat{C}$から取られたペア $(F, a)$ で自然だ。ここでは$F$を関手圏の*対象*として扱っていることに注意してほしい。

これが何を意味するのか少し考えてみよう。自然同型は2つの関手の間の反転可能な*自然変換*だ。そして実際、前述の同型の右辺は関手だ。それは$[\cat{C}, \Set]\times \cat{C}$から$\Set$への関手だ。ペア $(F, a)$ に対するその作用は集合だ――関手$F$を対象$a$において評価した結果だ。この関手は評価関手 (evaluation functor) と呼ばれる。

左辺も関手であり、$(F, a)$ を自然変換の集合$[\cat{C}, \Set](\cat{C}(a, -), F)$ に変換する。

これらが本当に関手だと示すには、射に対する作用も定義しなければならない。しかし、ペア $(F, a)$ と $(G, b)$ の間の射とは何だろうか？
それは射のペア $(\Phi, f)$ だ。1番目は関手間の射――自然変換――であり、2番目は$\cat{C}$内の正則な射だ。

評価関手はこのペア $(\Phi, f)$ を取り、2つの集合$F a$と$G b$の間の関数に写す。このような関数は、$a$における$\Phi$のコンポーネント（$F a$を$G a$に写す）と$G$によってリフトされた射$f$から、簡単に構築できる。

$$(G f) \cdot \Phi_a$$

$\Phi$の自然性により、これは次と同じであることに注意してほしい：

$$\Phi_b \cdot (F f)$$

同型射全体の自然性を証明するつもりはない――関手とは何かが掴めれば、ごく機械的に証明できる。それは同型が関手と自然変換から成り立っているという事実から導かれる。うまくいかないはずがない。

## 課題

1. 余米田埋め込みをHaskellで表現せよ。
2. `fromY`と`btoa`の間に確立された全単射が同型射であることを示せ（2つの写像は互いに逆だ）。
3. モノイドについて米田埋め込みを実現せよ。そのモノイドの単一の対象に対応する関手は何か？
   どのような自然変換がモノイド射に対応するか？

4. *共変*米田埋め込みの全順序への応用は何か？
  （この問いはGershom Bazermanによって提案された。）
5. 米田埋め込みを使えば、任意の関手圏$[\cat{C}, \cat{D}]$を関手圏$[[\cat{C}, \cat{D}], \Set]$に埋め込める。それが射（この場合は自然変換）にどう作用するか説明せよ。
